var app=function(){"use strict";function t(){}function e(t){return t()}function n(){return Object.create(null)}function r(t){t.forEach(e)}function o(t){return"function"==typeof t}function c(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function i(e,n,r){e.$$.on_destroy.push(function(e,...n){if(null==e)return t;const r=e.subscribe(...n);return r.unsubscribe?()=>r.unsubscribe():r}(n,r))}function s(t,e){t.appendChild(e)}function a(t,e,n){t.insertBefore(e,n||null)}function u(t){t.parentNode.removeChild(t)}function l(t){return document.createElement(t)}function d(t){return document.createTextNode(t)}function h(){return d(" ")}function f(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function P(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function p(t){return""===t?null:+t}function _(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function m(t,e){t.value=null==e?"":e}function b(t,e,n,r){t.style.setProperty(e,n,r?"important":"")}let E;function g(t){E=t}const y=[],v=[],S=[],I=[],N=Promise.resolve();let A=!1;function x(t){S.push(t)}let $=!1;const T=new Set;function O(){if(!$){$=!0;do{for(let t=0;t<y.length;t+=1){const e=y[t];g(e),R(e.$$)}for(g(null),y.length=0;v.length;)v.pop()();for(let t=0;t<S.length;t+=1){const e=S[t];T.has(e)||(T.add(e),e())}S.length=0}while(y.length);for(;I.length;)I.pop()();A=!1,$=!1,T.clear()}}function R(t){if(null!==t.fragment){t.update(),r(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(x)}}const w=new Set;function D(t,e){-1===t.$$.dirty[0]&&(y.push(t),A||(A=!0,N.then(O)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function L(c,i,s,a,l,d,h=[-1]){const f=E;g(c);const P=c.$$={fragment:null,ctx:null,props:d,update:t,not_equal:l,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(f?f.$$.context:[]),callbacks:n(),dirty:h,skip_bound:!1};let p=!1;if(P.ctx=s?s(c,i.props||{},((t,e,...n)=>{const r=n.length?n[0]:e;return P.ctx&&l(P.ctx[t],P.ctx[t]=r)&&(!P.skip_bound&&P.bound[t]&&P.bound[t](r),p&&D(c,t)),e})):[],P.update(),p=!0,r(P.before_update),P.fragment=!!a&&a(P.ctx),i.target){if(i.hydrate){const t=function(t){return Array.from(t.childNodes)}(i.target);P.fragment&&P.fragment.l(t),t.forEach(u)}else P.fragment&&P.fragment.c();i.intro&&((_=c.$$.fragment)&&_.i&&(w.delete(_),_.i(m))),function(t,n,c){const{fragment:i,on_mount:s,on_destroy:a,after_update:u}=t.$$;i&&i.m(n,c),x((()=>{const n=s.map(e).filter(o);a?a.push(...n):r(n),t.$$.on_mount=[]})),u.forEach(x)}(c,i.target,i.anchor),O()}var _,m;g(f)}function C(t){return{enumerable:!0,value:t}}function U(t){return{enumerable:!0,writable:!0,value:t}}let M={},q=()=>!0,k=()=>({}),H=t=>t,F=(t,e,n,r)=>t.apply(n,r)&&e.apply(n,r),B=(t,e,n,[r,o])=>e.call(n,t.call(n,r,o),o),Q=(t,e)=>Object.freeze(Object.create(t,e));function V(t,e,n){return t.reduce(((t,e)=>function(...r){return n(t,e,this,r)}),e)}function X(t){return Q(this,{fn:C(t)})}let Y={},W=X.bind(Y),j={},z=X.bind(j);function G(t,e){return e.filter((e=>t.isPrototypeOf(e)))}function J(t,e,...n){let r=V(G(j,n).map((t=>t.fn)),q,F),o=V(G(Y,n).map((t=>t.fn)),H,B);return Q(this,{from:C(t),to:C(e),guards:C(r),reducers:C(o)})}let Z={},K={},tt=J.bind(Z),et=J.bind(K,null);function nt(t,e,n){return dt(e,t,n,this.immediates)||t}function rt(t){let e=new Map;for(let n of t)e.has(n.from)||e.set(n.from,[]),e.get(n.from).push(n);return e}let ot={enter:H};function ct(...t){let e=G(Z,t),n=G(K,t),r={final:C(0===t.length),transitions:C(rt(e))};return n.length&&(r.immediates=C(n),r.enter=C(nt)),Q(ot,r)}let it={enter(t,e,n){return this.fn.call(e,e.context,n).then((t=>e.send({type:"done",data:t}))).catch((t=>e.send({type:"error",error:t}))),t}},st={enter(t,e,n){if(e.child=ft(this.machine,(t=>{e.onChange(t),e.child==t&&t.machine.state.value.final&&(delete e.child,e.send({type:"done",data:t.context}))}),e.context,n),e.child.machine.state.value.final){let n=e.child.context;return delete e.child,dt(e,t,{type:"done",data:n},this.transitions.get("done"))}return t}};function at(t,...e){let n=C(rt(e));return ut.isPrototypeOf(t)?Q(st,{machine:C(t),transitions:n}):Q(it,{fn:C(t),transitions:n})}let ut={get state(){return{name:this.current,value:this.states[this.current]}}};function lt(t,e,n=k){return"string"!=typeof t&&(n=e||k,e=t,t=Object.keys(e)[0]),M._create&&M._create(t,e),Q(ut,{context:C(n),current:C(t),states:C(e)})}function dt(t,e,n,r){let{context:o}=t;for(let{to:c,guards:i,reducers:s}of r)if(i(o,n)){t.context=s.call(t,o,n);let r=e.original||e,i=Q(r,{current:C(c),original:{value:r}});return i.state.value.enter(i,t,n)}}let ht={send(t){this.machine=function(t,e){let n=e.type||e,{machine:r}=t,{value:o}=r.state;return o.transitions.has(n)&&dt(t,r,e,o.transitions.get(n))||r}(this,t),this.onChange(this)}};function ft(t,e,n,r){let o=Object.create(ht,{machine:U(t),context:U(t.context(n,r)),onChange:C(e)});return o.send=o.send.bind(o),o.machine=o.machine.state.value.enter(o.machine,o,r),o}function Pt(t,e){throw new Error(`Cannot transition from ${t} to unknown state: ${e}`)}M._create=function(t,e){if(!(t in e))throw new Error(`Initial state [${t}] is not a known state.`);for(let t in e){let n=e[t];for(let[,r]of n.transitions)for(let{to:n}of r)n in e||Pt(t,n)}};class pt extends EventTarget{constructor(t){super(),this.device=t,this.interfaceNumber=0,this.endpointIn=0,this.endpointOut=0,this.queue=[],this.transferInflight=!1}onReceive(t){}onReceiveError(t){}setEndpoints(){let t=this.device.configuration.interfaces;console.log("Interfaces",this.device.configuration.interfaces),t.forEach((t=>{console.log("Element",t),t.alternates.forEach((e=>{255==e.interfaceClass&&(this.interfaceNumber=t.interfaceNumber,e.endpoints.forEach((t=>{"out"==t.direction&&(this.endpointOut=t.endpointNumber),"in"==t.direction&&(this.endpointIn=t.endpointNumber)})))}))})),0===this.endpointIn&&console.error("endpointIn is 0"),0===this.endpointOut&&console.error("endpointOut is 0")}async connect(){let t=async()=>{try{const e=await this.device.transferIn(this.endpointIn,64);this.onReceive(e.data),t()}catch(t){this.onReceiveError(t)}};try{if(await this.device.open(),null===this.device.configuration)return this.device.selectConfiguration(1);await this.setEndpoints(),console.log("Interface number:",this.interfaceNumber),console.log("Configuration:",this.device.configuration),await this.device.claimInterface(this.interfaceNumber);try{await this.device.selectAlternateInterface(this.interfaceNumber,this.endpointIn)}catch(t){}await this.device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:1,index:this.interfaceNumber}),t()}catch(t){console.error(t)}}async disconnect(){return this.device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:0,index:this.interfaceNumber}).then((()=>this.device.close()))}send(t){return console.log("sending",t,this.endpointOut),this.device.transferOut(this.endpointOut,t)}queueMessage(t){if(queue.length>5e3)return console.warn("You have queued too many messages, have more chill");this.queue.push(t)}async processQueue(){if(0===this.queue.length)return;if(this.transferInflight)return;this.transferInflight=!0;const t=this.queue.shift();try{await this.send(t)}catch(e){console.error(e),this.queue.unshift(t)}this.transferInflight=!1}startQueue(){this.stopQueue(),this.queueInterval=setInterval(this.processQueue.bind(this),1)}stopQueue(){this.queueInterval&&clearInterval(this.queueInterval)}}P_PWM,P_DRIVE,P_PITCH,P_OCT,P_GLIDE,P_INTERVAL,P_NOISE,P_MIXRESO,P_ROTATE,P_SCALE,P_MICROTUNE,P_STRIDE,P_SENS,P_A,P_D,P_S,P_R,P_ENV1_UNUSED,P_ENV_LEVEL1,P_A2,P_D2,P_S2,P_R2,P_ENV2_UNUSED,P_DLSEND,P_DLTIME,P_DLRATIO,P_DLWOB,P_DLFB,P_TEMPO,P_RVSEND,P_RVTIME,P_RVSHIM,P_RVWOB,P_RVUNUSED,P_SWING,P_ARPONOFF,P_ARPMODE,P_ARPDIV,P_ARPPROB,P_ARPLEN,P_ARPOCT,P_LATCHONOFF,P_SEQMODE,P_SEQDIV,P_SEQPROB,P_SEQLEN,P_GATE_LENGTH,P_SMP_POS,P_SMP_GRAINSIZE,P_SMP_RATE,P_SMP_TIME,P_SAMPLE,P_SEQPAT,P_JIT_POS,P_JIT_GRAINSIZE,P_JIT_RATE,P_JIT_PULSE,P_JIT_UNUSED,P_SEQSTEP,P_ASCALE,P_AOFFSET,P_ADEPTH,P_AFREQ,P_ASHAPE,P_AWARP,P_BSCALE,P_BOFFSET,P_BDEPTH,P_BFREQ,P_BSHAPE,P_BWARP,P_XSCALE,P_XOFFSET,P_XDEPTH,P_XFREQ,P_XSHAPE,P_XWARP,P_YSCALE,P_YOFFSET,P_YDEPTH,P_YFREQ,P_YSHAPE,P_YWARP,P_MIXSYNTH,P_MIXWETDRY,P_MIXHPF,P_MIX_UNUSED,P_CV_QUANT,P_HEADPHONE,P_MIXINPUT,P_MIXINWETDRY,P_SYS_UNUSED1,P_SYS_UNUSED2,P_SYS_UNUSED3,P_ACCEL_SENS,P_LAST;const _t=[];const mt=(e,n)=>{const r=ft(e,(t=>{r===t&&(console.log("[MachineStore] state",t.machine.current,"context",t.context),o.set({state:t.machine.current,context:t.context}))}),n),o=function(e,n=t){let r;const o=[];function i(t){if(c(e,t)&&(e=t,r)){const t=!_t.length;for(let t=0;t<o.length;t+=1){const n=o[t];n[1](),_t.push(n,e)}if(t){for(let t=0;t<_t.length;t+=2)_t[t][0](_t[t+1]);_t.length=0}}}return{set:i,update:function(t){i(t(e))},subscribe:function(c,s=t){const a=[c,s];return o.push(a),1===o.length&&(r=n(i)||t),c(e),()=>{const t=o.indexOf(a);-1!==t&&o.splice(t,1),0===o.length&&(r(),r=null)}}}}({state:e.current,context:r.context}),i=r.send;return{store:o,send:i,service:r}};const bt={idle:ct(et("getHeader",(Et=async function(t){console.log("sendPatchRequest",t.port,t.patchNumber);const e=new Uint8Array([243,15,171,202,0,t.patchNumber,0,0,0,0]);return t.port.send(e),!0},W(((t,e)=>!!~Et(t,e)&&t))))),getHeader:ct(tt("data","header",z((function(t,e){console.log("hasHeader",t,e);const n=new Uint8Array(e.data);return!!n&&(10===n.byteLength&&(243===n[0]&&(15===n[1]&&(171===n[2]&&(202===n[3]&&(1===n[4]&&(0===n[6]&&0===n[7])))))))})))),header:ct(et("read",W((function(t,e){const n=new Uint8Array(e.data);return t.result=[],t.header=n,t.slot=n[5],t.readBytes=0,t.bytesToRead=n[8]+256*n[9],console.log(`Loading from slot: ${t.slot} - Expecting ${t.bytesToRead} bytes (header: ${t.header})`),t})))),read:ct(et("finished",z((function(t){return t.readBytes>=t.bytesToRead}))),tt("data","read",W((function(t,e){const n=new Uint8Array(e.data);return t.result.push(n),t.readBytes+=n.byteLength,t})))),finished:ct()};var Et;ct(tt("header"));const gt=lt(bt,(t=>({...t})));class yt extends pt{onReceive(t){console.log("Port data:",t.buffer);const{service:e}=St;e.child?e.child.send({type:"data",data:t.buffer}):e.send({type:"data",data:t.buffer})}onReceiveError(t){console.error("Port error:",t);const{send:e}=St;e({type:"error",data:t})}}async function vt(t){return t.port=await class{constructor(){}static async getPorts(t){return navigator.usb.getDevices().then((e=>e.map((e=>t?new t(e):new pt(e)))))}static async requestPort(t){return navigator.usb.requestDevice({filters:[{vendorId:9114},{vendorId:51966}]}).then((e=>new t?new t(e):new pt(e)))}}.requestPort(yt),await t.port.connect(),t}const St=function(t={}){const e=lt({disconnected:ct(tt("connect","connecting")),connecting:at(vt,tt("done","connected"),tt("error","disconnected")),connected:ct(tt("loadPatch","loadPatch",W(((t,e)=>(console.log("ctx",t,e),{...t,patchNumber:e.patchNumber})))),tt("savePatch","savePatch")),loadPatch:at(gt,tt("done","connected",W(((t,e)=>({...t,patch:Uint8Array.from(Array.prototype.concat(...e.data.result.map((t=>Array.from(t)))))})))),tt("error","error",W(((t,e)=>(console.error(t,e),t))))),savePatch:ct(),error:ct(tt("disconnect","disconnected"))},(t=>({...t})));return mt(e,Object.assign(t,{port:null,patch:null}))}({patchNumber:0});function It(e){let n;return{c(){n=l("p"),n.textContent="No patch in browser memory"},m(t,e){a(t,n,e)},p:t,d(t){t&&u(n)}}}function Nt(t){let e,n,r,o,c=t[0].context.patch.byteLength+"";return{c(){e=l("p"),n=d("Loaded: "),r=d(c),o=d(" bytes")},m(t,c){a(t,e,c),s(e,n),s(e,r),s(e,o)},p(t,e){1&e&&c!==(c=t[0].context.patch.byteLength+"")&&_(r,c)},d(t){t&&u(e)}}}function At(e){let n,o,c,i,E,g,y,v,S,I,N,A,x,$,T,O,R,w,D,L,C,U,M,q,k,H=e[0].state+"";function F(t,e){return t[0].context.patch?Nt:It}let B=F(e),Q=B(e);return{c(){n=l("main"),o=l("h1"),o.textContent="Plinky WebUSB playground",c=h(),i=l("h2"),E=d("Current state: "),g=d(H),y=h(),v=l("button"),S=d("Connect"),I=h(),N=l("div"),A=l("label"),A.textContent="Patch number",x=h(),$=l("input"),T=h(),O=l("button"),R=d("Load patch"),w=h(),D=l("button"),L=d("Save patch"),C=h(),U=l("h2"),U.textContent="Current patch",M=h(),Q.c(),P(o,"class","svelte-yfzur"),b(v,"display",e[1]?"none":"block"),P(v,"class","svelte-yfzur"),P(A,"for","i-patch-number"),P($,"type","number"),$.disabled=e[2],P($,"id","i-patch-number"),O.disabled=e[2],P(O,"class","svelte-yfzur"),D.disabled=e[2],P(D,"class","svelte-yfzur"),b(N,"display",e[1]?"block":"none"),P(n,"class","svelte-yfzur")},m(t,r){a(t,n,r),s(n,o),s(n,c),s(n,i),s(i,E),s(i,g),s(n,y),s(n,v),s(v,S),s(n,I),s(n,N),s(N,A),s(N,x),s(N,$),m($,e[0].context.patchNumber),s(N,T),s(N,O),s(O,R),s(N,w),s(N,D),s(D,L),s(n,C),s(n,U),s(n,M),Q.m(n,null),q||(k=[f(v,"click",e[4]),f($,"input",e[6]),f(O,"click",e[5]),f(D,"click",xt)],q=!0)},p(t,[e]){1&e&&H!==(H=t[0].state+"")&&_(g,H),2&e&&b(v,"display",t[1]?"none":"block"),4&e&&($.disabled=t[2]),1&e&&p($.value)!==t[0].context.patchNumber&&m($,t[0].context.patchNumber),4&e&&(O.disabled=t[2]),4&e&&(D.disabled=t[2]),2&e&&b(N,"display",t[1]?"block":"none"),B===(B=F(t))&&Q?Q.p(t,e):(Q.d(1),Q=B(t),Q&&(Q.c(),Q.m(n,null)))},i:t,o:t,d(t){t&&u(n),Q.d(),q=!1,r(k)}}}function xt(){}function $t(t,e,n){let r,o,c;const{store:s,send:a,service:u}=St;return i(t,s,(t=>n(0,c=t))),t.$$.update=()=>{1&t.$$.dirty&&n(1,r=["connected","loadPatch","savePatch"].indexOf(c.state)>-1),1&t.$$.dirty&&n(2,o=["loadPatch","savePatch"].indexOf(c.state)>-1)},[c,r,o,s,async function(){a("connect")},function(){a({type:"loadPatch",patchNumber:c.context.patchNumber})},function(){c.context.patchNumber=p(this.value),s.set(c)}]}return new class extends class{$destroy(){!function(t,e){const n=t.$$;null!==n.fragment&&(r(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}{constructor(t){super(),L(this,t,$t,At,c,{})}}({target:document.body})}();
//# sourceMappingURL=bundle.js.map
